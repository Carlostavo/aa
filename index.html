<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Residuos Sólidos — Editor Pro</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.3/css/all.min.css">
<!-- Incluir Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --primary:#2e7d32;
    --primary-600:#1b5e20;
    --secondary:#0288d1;
    --accent:#fbc02d;
    --danger:#d32f2f;
    --bg:#f4f7f9;
    --surface:#ffffff;
    --ink:#2d3748;
    --muted:#718096;
    --border:#e2e8f0;
    --grid:#e6f3ea;
    --shadow:0 8px 30px rgba(16,24,40,0.08);
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);min-height:100vh}

  /* Topbar */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--surface);box-shadow:var(--shadow);position:sticky;top:0;z-index:30}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--primary)}
  .brand i{background:linear-gradient(135deg,var(--primary),#3fa34b);-webkit-background-clip:text;background-clip:text;color:transparent}
  .nav{display:flex;align-items:center;gap:14px}
  .nav a{color:var(--muted);text-decoration:none;font-weight:600;padding:8px 10px;border-radius:10px}
  .nav a.active{color:var(--primary);background:#e8f4ec}
  .nav a.disabled{pointer-events:none;opacity:.45}
  .nav a.active-link { color: var(--primary); background: #e8f4ec; }

  /* Login button */
  #open-auth{border:none;padding:10px 16px;border-radius:999px;color:#fff;background:linear-gradient(135deg,var(--secondary),#00a6c7);box-shadow:0 6px 20px rgba(2,136,209,.25);font-weight:700;cursor:pointer;transition:.25s}
  #open-auth:hover{transform:translateY(-1px);box-shadow:0 10px 30px rgba(2,136,209,.35)}
  
  /* Logout button */
  #logout-btn{display:none;border:none;padding:10px 16px;border-radius:999px;color:#fff;background:var(--danger);font-weight:700;cursor:pointer;transition:.25s}
  #logout-btn:hover{background:#b71c1c}

  /* Edit toggle */
  #toggle-edit{display:none;border:none;padding:10px 14px;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
  #toggle-edit.active{background:var(--primary-600)}

  /* Layout */
  .wrap{display:grid;grid-template-columns:1fr;gap:18px;align-items:start;padding:18px;min-height: calc(100vh - 86px)}
  .wrap.edit-active{grid-template-columns:320px 1fr;}
  .sidebar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;display:none;position:sticky;top:86px;overflow:auto}
  .sidebar.active{display:block}
  .panel h3{margin:10px 0 8px;font-size:14px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row{display:flex;gap:8px}
  .panel .field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
  .panel label{font-size:12px;color:#667085}
  .panel input,.panel select,.panel textarea, .panel button{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:13px}
  .panel button.action{background:#0ea5e9;border:none;color:#fff;font-weight:700;cursor:pointer}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .tab{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#f8fafc;font-size:12px;cursor:pointer}
  .tab.active{background:#e8f4ec;border-color:#b7dec2;color:#1f7a34}
  .section{display:none}
  .section.active{display:block}

  /* Canvas */
  .canvas-wrap{position:relative;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:0;overflow:hidden;flex-grow:1;display:flex;flex-direction:column}
  .canvas-toolbar{display:none; align-items:center;gap:8px;padding:10px;background:var(--surface);border-bottom:1px solid var(--border)}
  .canvas-toolbar.active{display:flex;}
  .canvas-toolbar .label{display:none;}
  .canvas-toolbar .buttons{display:none;}
  .canvas-toolbar.active .label, .canvas-toolbar.active .buttons{display:block;}

  .canvas{
    position:relative;
    background-size:20px 20px;
    overflow: hidden; 
    padding:20px;
    height: auto;
    min-height: calc(100vh - 120px);
  }

  .canvas.editing {
    background-image: linear-gradient(to right, var(--grid) 1px, transparent 1px), linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
    border: 1px dashed #d7e7dc;
  }
  
  .canvas-item{position:absolute;min-width:80px;min-height:40px;outline:none;}
  .canvas-item:not(.is-editing) .selectable {cursor: move;}
  .selectable{cursor:move}
  .selected{outline:2px solid #22c55e;box-shadow:0 8px 24px rgba(15,118,110,.18);z-index: 20;}
  .handle{position:absolute;width:10px;height:10px;border-radius:2px;background:#22c55e;border:1px solid #0f766e}
  .handle.n{top:-6px;left:50%;transform:translateX(-50%);cursor:n-resize}
  .handle.s{bottom:-6px;left:50%;transform:translateX(-50%);cursor:s-resize}
  .handle.e{right:-6px;top:50%;transform:translateY(-50%);cursor:e-resize}
  .handle.w{left:-6px;top:50%;transform:translateY(-50%);cursor:w-resize}
  .handle.nw{left:-6px;top:-6px;cursor:nw-resize}
  .handle.ne{right:-6px;top:-6px;cursor:ne-resize}
  .handle.sw{left:-6px;bottom:-6px;cursor:sw-resize}
  .handle.se{right:-6px;bottom:-6px;cursor:se-resize}
  .handle.rotate{top:-28px;left:50%;transform:translateX(-50%);width:14px;height:14px;border-radius:50%;background:#0ea5e9;border:2px solid #0369a1;cursor:grab}

  /* Floating tools for selected */
  .floatbar{
    position:absolute;
    display:none;
    background:var(--primary);
    color:#fff;
    padding: 2px;
    border-radius: 8px;
    font-size:12px;
    z-index:30;
    top: -42px;
    white-space: nowrap;
    box-shadow: var(--shadow);
    left: 50%;
    transform: translateX(-50%);
  }
  .floatbar button{
    background:transparent;
    border:none;
    color:#fff;
    cursor:pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background-color 0.2s;
  }
  .floatbar button:hover {
    background-color: var(--primary-600);
  }
  .floatbar button i {
    color: #fff;
    font-size: 14px;
  }
  .floatbar button span {
    font-size: 12px;
    font-weight: 500;
  }
  .selected .floatbar {
    display: flex;
  }
  
  /* Content sections */
  .content-section { display: none; }
  .content-section.active { display: block; }
  
  /* Home section */
  .home{padding:0}
  
  /* Hero section - Updated */
  .hero{
    padding: 60px 28px;
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 16px;
    margin-bottom: 30px;
    border: 1px solid var(--border);
    background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M100 0L50 50L100 100V0ZM0 100L50 50L0 0V100Z" fill="%23e8f4ec" opacity=".5"%3E%3C/path%3E%3C/svg%3E'),
                    linear-gradient(135deg, #e8f5e9, #f1f8e9);
    background-size: 200px, cover;
  }
  .hero h1{margin:0;color:var(--primary);font-size:2.8rem;line-height:1.2; max-width: 800px;}
  .hero p{margin:0;color:#48576a;font-size:1.2rem; max-width: 700px;}
  .hero-button {
    background: var(--primary);
    color: #fff;
    padding: 14px 28px;
    border-radius: 999px;
    font-weight: 700;
    text-decoration: none;
    margin-top: 10px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .hero-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(46,125,50,0.25);
  }
  
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:24px;margin-top:36px}
  .card{
    padding:24px;
    border-radius:20px;
    background:var(--surface);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    display:flex;
    flex-direction: column;
    gap:18px;
    align-items:flex-start;
    transition:transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
  }
  .card:hover{transform:translateY(-5px);box-shadow:0 12px 20px rgba(0,0,0,0.1)}
  .card-icon {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-icon i{font-size:24px; color: #fff;}
  .card.metas .card-icon { background: #38a169; }
  .card.indicadores .card-icon { background: #4299e1; }
  .card.avances .card-icon { background: #ecc94b; }
  .card.reportes .card-icon { background: #e53e3e; }
  .card.formularios .card-icon { background: #673ab7; }

  .card-content{display:flex;flex-direction:column;gap:6px;}
  .card-title{font-weight:700;font-size:1.2rem; margin: 0;}
  .card-desc{font-size:1rem;color:var(--muted); margin: 0;}

  /* New style for disabled cards */
  .card.disabled {
    pointer-events: none;
    opacity: 0.6;
    cursor: not-allowed;
    background: #f1f5f9;
  }
  .card.disabled:hover {
    transform: none;
    box-shadow: var(--shadow);
  }

  /* Auth modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .sheet{background:var(--surface);width:360px;max-width:92vw;border-radius:18px;box-shadow:var(--shadow);overflow:hidden;padding:24px;}
  .sheet h2{text-align:center;margin:0 0 20px;color:var(--ink);font-size:22px;}
  .sheet-body{display:flex;flex-direction:column;gap:12px;}
  .sheet-body label{color:var(--muted); font-size: 0.9rem;}
  .sheet-body input, .sheet-body select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:14px;}
  .sheet-body .submit{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--primary),#3fa34b);color:#fff;font-weight:800;cursor:pointer;transition:.2s all;}
  .sheet-body .submit:hover{transform:translateY(-1px);box-shadow:0 6px 12px rgba(46,125,50,0.25);}
  .sheet-body .close-modal{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;background:transparent;color:var(--muted);font-weight:800;cursor:pointer;transition:.2s all;}
  .sheet-body .close-modal:hover{background:#f1f5f9;border-color:#cbd5e1;}
  .close-x{position:absolute;top:10px;right:14px;background:transparent;border:none;font-size:18px;color:#334155;cursor:pointer}

  /* Canvas items styling */
  .canvas-h2 {font-size: 1.8rem; color: var(--primary); margin: 0; padding: 10px; background: rgba(255,255,255,0.9); border-radius: 10px; border: 1px solid var(--border);}
  .canvas-p {font-size: 1rem; color: var(--ink); margin: 0; padding: 10px; background: rgba(255,255,255,0.9); border-radius: 10px; border: 1px solid var(--border); line-height: 1.5;}
  .canvas-img {border-radius: 10px; box-shadow: var(--shadow); width: 100%; height: 100%; object-fit: cover;}
  .canvas-button {display: inline-block; padding: 12px 20px; border-radius: 12px; background: var(--secondary); color: #fff; font-weight: 700; text-decoration: none; text-align: center; box-shadow: 0 4px 6px rgba(2,136,209,.2); transition: all 0.2s;}
  .canvas-button:hover {background: #0277bd; transform: translateY(-2px); box-shadow: 6px 12px rgba(2,136,209,.3);}
  .canvas-table { width: 100%; height: 100%; border-collapse: collapse; }
  .canvas-table th, .canvas-table td { border: 1px solid var(--border); padding: 8px; text-align: left; }
  .canvas-table td { background-color: white; }

  /* New file input style */
  #upload-image-label {
    display: block;
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    background: #0ea5e9;
    border: none;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    text-align: center;
    transition: background-color 0.2s;
  }
  #upload-image-label:hover {
    background: #0369a1;
  }
  #image-upload {
    display: none;
  }

  /* Make sure all children can be interacted with */
  .canvas-item > *, .hero > *, .card > * {
    pointer-events: all;
  }

  /* Added for styling of editable content */
  [contenteditable="true"] {
      outline: 2px dashed var(--secondary);
      outline-offset: 4px;
      padding: 2px;
  }


/* ================= RESPONSIVE DESIGN ================= */
@media (max-width: 768px) {
  /* Topbar */
  .topbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .nav {
    flex-wrap: wrap;
    gap: 8px;
  }

  /* Sidebar -> se vuelve un panel inferior */
  .wrap.edit-active {
    grid-template-columns: 1fr; /* en móvil no mostrar 2 columnas */
  }
  .sidebar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50vh;
    z-index: 100;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -6px 20px rgba(0,0,0,0.2);
  }

  /* Hero */
  .hero {
    padding: 30px 16px;
  }
  .hero h1 {
    font-size: 1.8rem;
  }
  .hero p {
    font-size: 1rem;
  }

  /* Cards -> 1 por fila */
  .cards {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  /* Canvas */
  .canvas {
    padding: 10px;
    min-height: 60vh;
  }
}

</style>
</head>
<body>

<header class="topbar">
  <div class="brand"><i class="fa-solid fa-recycle fa-xl"></i> Gestión RS</div>
  <nav class="nav">
    <a href="#" class="nav-link active" data-page="home">Inicio</a>
    <a href="#" class="nav-link" data-page="indicadores">Indicadores</a>
    <a href="#" class="nav-link disabled" data-page="metas">Metas</a>
    <a href="#" class="nav-link disabled" data-page="avances">Avances</a>
    <a href="#" class="nav-link disabled" data-page="reportes">Reportes</a>
    <a href="#" class="nav-link" data-page="formularios">Formularios</a>
    <button id="toggle-edit"><i class="fa-solid fa-pen-to-square"></i> Modo edición</button>
    <button id="open-auth"><i class="fa-solid fa-right-to-bracket"></i> Iniciar sesión</button>
    <button id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
    <span id="whoami" style="font-weight:700;display:none"></span>
  </nav>
</header>

<main class="wrap" id="main-wrap">
  <aside class="sidebar" id="sidebar">
    <div class="panel">
      <h3>Insertar</h3>
      <div class="grid-2">
        <button class="action" data-insert="h2"><i class="fa-solid fa-heading"></i> Título</button>
        <button class="action" data-insert="p"><i class="fa-solid fa-font"></i> Texto</button>
        <button class="action" data-insert="img"><i class="fa-regular fa-image"></i> Imagen</button>
        <button class="action" data-insert="button"><i class="fa-solid fa-square"></i> Botón</button>
        <button class="action" data-insert="iframe"><i class="fa-solid fa-video"></i> Video</button>
        <button class="action" data-insert="table"><i class="fa-solid fa-table"></i> Tabla</button>
      </div>

      <h3>Historial</h3>
      <div class="row">
        <button class="action" id="undo"><i class="fa-solid fa-rotate-left"></i> Deshacer</button>
        <button class="action" id="redo"><i class="fa-solid fa-rotate-right"></i> Rehacer</button>
      </div>

      <h3>Propiedades</h3>
      <div class="tabs" id="prop-tabs">
        <button class="tab active" data-tab="general">General</button>
        <button class="tab" data-tab="texto">Texto</button>
        <button class="tab" data-tab="imagen">Imagen</button>
        <button class="tab" data-tab="video">Video</button>
        <button class="tab" data-tab="boton">Botón</button>
        <button class="tab" data-tab="tabla">Tabla</button>
        <button class="tab" data-tab="lienzo">Lienzo</button>
      </div>

      <section class="section active" id="sec-general">
        <div class="grid-2">
          <div class="field"><label>X</label><input type="number" id="gen-x"></div>
          <div class="field"><label>Y</label><input type="number" id="gen-y"></div>
          <div class="field"><label>Ancho</label><input type="number" id="gen-w"></div>
          <div class="field"><label>Alto</label><input type="number" id="gen-h"></div>
          <div class="field"><label>Rotación (°)</label><input type="number" id="gen-rot" value="0"></div>
          <div class="field"><label>Índice Z</label><input type="number" id="gen-z" value="1"></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Fondo</label><input type="color" id="gen-bg" value="#ffffff"></div>
          <div class="field"><label>Color Borde</label><input type="color" id="gen-bc" value="#e2e8f0"></div>
          <div class="field"><label>Grosor Borde (px)</label><input type="number" id="gen-bw" value="0"></div>
          <div class="field"><label>Radio (px)</label><input type="number" id="gen-br" value="8"></div>
          <div class="field"><label>Sombra</label>
            <select id="gen-shadow">
              <option value="none">Sin sombra</option>
              <option value="sm">Suave</option>
              <option value="md">Media</option>
              <option value="lg">Fuerte</option>
            </select>
          </div>
          <div class="field"><label>Padding</label><input type="number" id="gen-pad" value="8"></div>
        </div>
      </section>

      <section class="section" id="sec-texto">
        <div class="field"><label>Contenido</label><textarea id="txt-content" rows="4"></textarea></div>
        <div class="grid-2">
          <div class="field"><label>Fuente</label>
            <select id="txt-font">
              <option>Inter</option><option>Arial</option><option>Georgia</option>
              <option>Tahoma</option><option>Verdana</option><option>Times New Roman</option>
            </select>
          </div>
          <div class="field"><label>Tamaño (px)</label><input type="number" id="txt-size" value="18"></div>
          <div class="field"><label>Color</label><input type="color" id="txt-color" value="#243b53"></div>
          <div class="field"><label>Alineación</label>
            <select id="txt-align"><option>left</option><option>center</option><option>right</option><option>justify</option></select>
          </div>
        </div>
        <div class="row">
          <button class="action" id="txt-bold"><i class="fa-solid fa-bold"></i> Negrita</button>
          <button class="action" id="txt-italic"><i class="fa-solid fa-italic"></i> Cursiva</button>
          <button class="action" id="txt-underline"><i class="fa-solid fa-underline"></i> Subrayado</button>
          <button class="action" id="txt-list"><i class="fa-solid fa-list-ul"></i> Lista</button>
        </div>
      </section>

      <section class="section" id="sec-imagen">
        <div class="field"><label>URL</label><input type="text" id="img-src" placeholder="https://..."></div>
        <label for="image-upload" id="upload-image-label">Subir desde PC</label>
        <input type="file" id="image-upload" accept="image/*">
        <div class="grid-2">
          <div class="field"><label>Fit</label>
            <select id="img-fit"><option value="cover">cover</option><option value="contain">contain</option></select>
          </div>
          <div class="field><label>Alt</label><input type="text" id="img-alt"></div>
          <div class="field><label>Ancho (px)</label><input type="number" id="img-w"></div>
          <div class="field><label>Alto (px)</label><input type="number" id="img-h"></div>
        </div>
      </section>

      <section class="section" id="sec-video">
        <div class="field><label>URL (YouTube)</label><input type="text" id="vid-src" placeholder="Pega la URL del video"></div>
        <input type="file" id="video-upload" style="display:none" accept="video/*">
        <button class="action" id="upload-btn">Subir desde PC</button>
        <div class="grid-2">
          <div class="field><label>Ancho (px)</label><input type="number" id="vid-w"></div>
          <div class="field><label>Alto (px)</label><input type="number" id="vid-h"></div>
        </div>
      </section>

      <section class="section" id="sec-boton">
        <div class="grid-2">
          <div class="field><label>Texto</label><input type="text" id="btn-text"></div>
          <div class="field><label>Enlace</label><input type="text" id="btn-href"></div>
          <div class="field><label>Fondo</label><input type="color" id="btn-bg" value="#0288d1"></div>
          <div class="field><label>Texto</label><input type="color" id="btn-fg" value="#ffffff"></div>
          <div class="field><label>Radio (px)</label><input type="number" id="btn-radius" value="12"></div>
          <div class="field><label>Padding (px)</label><input type="number" id="btn-pad" value="10"></div>
        </div>
      </section>

      <section class="section" id="sec-tabla">
        <div class="grid-2">
          <button class="action" id="tbl-add-row">+ Fila</button>
          <button class="action" id="tbl-del-row">- Fila</button>
          <button class="action" id="tbl-add-col">+ Columna</button>
          <button class="action" id="tbl-del-col">- Columna</button>
        </div>
        <div class="grid-2">
          <div class="field><label>Borde color</label><input type="color" id="tbl-bc" value="#94a3b8"></div>
          <div class="field><label>Borde (px)</label><input type="number" id="tbl-bw" value="1"></div>
          <div class="field><label>Color celdas</label><input type="color" id="tbl-cell" value="#ffffff"></div>
          <div class="field><label>Padding celda</label><input type="number" id="tbl-pad" value="8"></div>
        </div>
      </section>

      <section class="section" id="sec-lienzo">
        <div class="grid-2">
          <div class="field><label>Grid (px)</label><input type="number" id="canvas-grid" value="20"></div>
          <div class="field><label>Snap a grid</label>
            <select id="canvas-snap"><option value="on">on</option><option value="off">off</select>
          </div>
        </div>
      </section>
    </div>
  </aside>

  <section class="canvas-wrap">
    <div class="canvas-toolbar" id="canvas-toolbar">
      <span style="font-weight:800;color:#334155" class="label">Lienzo</span>
      <div style="margin-left:auto;display:flex;gap:8px" class="buttons">
        <button class="tab" id="bring-front"><i class="fa-solid fa-arrow-up"></i> Frente</button>
        <button class="tab" id="send-back"><i class="fa-solid fa-arrow-down"></i> Fondo</button>
        <button class="tab" id="duplicate"><i class="fa-regular fa-copy"></i> Duplicar</button>
        <button class="tab" id="remove"><i class="fa-regular fa-trash-can"></i> Eliminar</button>
      </div>
    </div>
    <div class="canvas" id="canvas">
      </div>
    <div class="floatbar" id="floatbar">
      <button id="fb-dup" title="Duplicar"><i class="fa-regular fa-copy"></i><span>Duplicar</span></button>
      <button id="fb-front" title="Traer al frente"><i class="fa-solid fa-arrow-up"></i><span>Frente</span></button>
      <button id="fb-back" title="Enviar al fondo"><i class="fa-solid fa-arrow-down"></i><span>Fondo</span></button>
      <button id="fb-del" title="Eliminar"><i class="fa-regular fa-trash-can"></i><span>Eliminar</span></button>
    </div>
  </section>
</main>

<div class="modal" id="auth">
  <div class="sheet">
    <button class="close-x" id="auth-close"><i class="fa-solid fa-xmark"></i></button>
    <h2>Iniciar sesión</h2>
    <div class="sheet-body">
      <div class="field">
        <label for="login-user">Usuario</label>
        <input id="login-user" placeholder="admin / tecnico / viewer">
      </div>
      <div class="field">
        <label for="login-pass">Contraseña</label>
        <input id="login-pass" type="password" placeholder="1234">
      </div>
      <button class="submit" id="btn-login">Entrar</button>
      <button class="close-modal">Salir</button>
    </div>
  </div>
</div>

<script>
// Configuración de Supabase - CON TUS DATOS REALES
const SUPABASE_URL = 'https://lhnluarfjyzheezfrexr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxobmx1YXJmanl6aGVlemZyZXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzYyOTAsImV4cCI6MjA3MDU1MjI5MH0.igYpeqlYnWW5i9NvOHSvlow3J-yDdEGgK6LRxYwvGY0';

// Inicializar Supabase
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(() => {
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const mainWrap = qs('#main-wrap');
  const canvas = qs('#canvas');
  const sidebar = qs('#sidebar');
  const toggleEdit = qs('#toggle-edit');
  const openAuth = qs('#open-auth');
  const logoutBtn = qs('#logout-btn');
  const whoami = qs('#whoami');
  const navLinks = qsa('.nav .nav-link');
  const auth = qs('#auth');
  const closeAuthBtn = qs('.close-modal');
  const txtContentArea = qs('#txt-content');
  const floatbar = qs('#floatbar');
  const canvasToolbar = qs('#canvas-toolbar');
  
  let editMode = false;
  let role = 'viewer';
  let selected = null;
  let grid = 20;
  let snap = true;
  let currentEditable = null;
  let currentPage = 'home';
  const pageContent = {};
  const history = [];
  const redo = [];
  let saveTimeout;

  // Inicializar la aplicación
  initApp();

  async function initApp() {
    // Verificar si hay una sesión activa
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
      // Obtener información del usuario
      const { data: { user } } = await supabaseClient.auth.getUser();
      handleLoginSuccess(user.email || 'Usuario', user.id);
    }
    
    // Cargar contenido desde Supabase
    await loadContentFromSupabase();
    
    // Cargar la página de inicio
    loadPageContent('home');
    
    // Escuchar cambios en la autenticación
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        const user = session.user;
        handleLoginSuccess(user.email || 'Usuario', user.id);
      } else if (event === 'SIGNED_OUT') {
        handleLogout();
      }
    });
  }

  // Función para cargar contenido desde Supabase
  async function loadContentFromSupabase() {
    try {
      const { data, error } = await supabaseClient
        .from('page_content')
        .select('*');
      
      if (error) {
        console.error('Error al cargar contenido:', error);
        return;
      }
      
      // Organizar el contenido por páginas
      if (data && data.length > 0) {
        data.forEach(item => {
          pageContent[item.page] = item.content;
        });
      } else {
        // Inicializar con contenido por defecto si no hay datos
        initializeDefaultContent();
      }
    } catch (error) {
      console.error('Error al cargar contenido:', error);
      initializeDefaultContent();
    }
  }

  // Función para inicializar contenido por defecto
  function initializeDefaultContent() {
    pageContent.home = getDefaultContent('home');
    pageContent.indicadores = getDefaultContent('indicadores');
    pageContent.metas = getDefaultContent('metas');
    pageContent.avances = getDefaultContent('avances');
    pageContent.reportes = getDefaultContent('reportes');
    pageContent.formularios = getDefaultContent('formularios');
  }

  // Función para guardar contenido en Supabase
  async function saveContentToSupabase() {
    try {
      const contentToSave = {
        page: currentPage,
        content: canvas.innerHTML,
        updated_at: new Date().toISOString()
      };
      
      // Verificar si ya existe contenido para esta página
      const { data: existingData } = await supabaseClient
        .from('page_content')
        .select('id')
        .eq('page', currentPage)
        .single();
      
      let error;
      if (existingData) {
        // Actualizar registro existente
        const { error: updateError } = await supabaseClient
          .from('page_content')
          .update(contentToSave)
          .eq('page', currentPage);
        error = updateError;
      } else {
        // Insertar nuevo registro
        const { error: insertError } = await supabaseClient
          .from('page_content')
          .insert([contentToSave]);
        error = insertError;
      }
      
      if (error) {
        console.error('Error al guardar contenido:', error);
      } else {
        console.log('Contenido guardado exitosamente');
        // Actualizar el contenido local
        pageContent[currentPage] = canvas.innerHTML;
      }
    } catch (error) {
      console.error('Error al guardar contenido:', error);
    }
  }

  // Función para obtener contenido por defecto
  function getDefaultContent(page) {
    const pageData = {
      home: `
        <div class="hero"><h1 class="editable-text">Sistema de Gestión de Residuos Sólidos</h1><p class="editable-text">La plataforma para monitorear indicadores, gestionar metas y generar reportes para una gestión ambiental eficiente.</p><a href="#" class="hero-button">Comenzar</a></div>
        <div class="cards">
          <div class="card metas disabled" data-page="metas"><div class="card-icon"><i class="fa-solid fa-bullseye"></i></div><div class="card-content"><div class="card-title editable-text">Gestión de Metas</div><div class="card-desc editable-text">Establece y sigue tus objetivos de sostenibilidad de manera intuitiva.</div></div></div>
          <div class="card indicadores" data-page="indicadores"><div class="card-icon"><i class="fa-solid fa-chart-line"></i></div><div class="card-content"><div class="card-title editable-text">Dashboard de Indicadores</div><div class="card-desc editable-text">Visualiza en tiempo real el rendimiento del sistema de gestión.</div></div></div>
          <div class="card avances disabled" data-page="avances"><div class="card-icon"><i class="fa-solid fa-chart-area"></i></div><div class="card-content"><div class="card-title editable-text">Seguimiento de Avances</div><div class="card-desc editable-text">Revisa el progreso de tus proyectos de reciclaje y reducción de residuos.</div></div></div>
          <div class="card reportes disabled" data-page="reportes"><div class="card-icon"><i class="fa-solid fa-file-lines"></i></div><div class="card-content"><div class="card-title editable-text">Generación de Reportes</div><div class="card-desc editable-text">Crea y exporta informes detallados para auditorías o análisis.</div></div></div>
          <div class="card formularios" data-page="formularios"><div class="card-icon"><i class="fa-solid fa-file-alt"></i></div><div class="card-content"><div class="card-title editable-text">Formularios de Datos</div><div class="card-desc editable-text">Ingresa y gestiona datos a través de formularios personalizados.</div></div></div>
        </div>
      `,
      indicadores: `
        <div class="hero"><h1 class="editable-text">Dashboard de Indicadores Clave</h1><p class="editable-text">Aquí podrás ver todos los indicadores de gestión de residuos en tiempo real. Utiliza las herramientas de edición para añadir gráficos y métricas.</p></div>
        <div class="cards">
          <div class="card metas"><div class="card-icon"><i class="fa-solid fa-recycle"></i></div><div class="card-content"><div class="card-title editable-text">Métricas de Reciclaje</div><div class="card-desc editable-text">Cantidad de material reciclado por mes, tasa de recuperación, etc.</div></div></div>
          <div class="card indicadores"><div class="card-icon"><i class="fa-solid fa-dollar-sign"></i></div><div class="card-content"><div class="card-title editable-text">Indicadores Financieros</div><div class="card-desc editable-text">Costos de gestión, ingresos por ventas de material, etc.</div></div></div>
          <div class="card avances"><div class="card-icon"><i class="fa-solid fa-road"></i></div><div class="card-content"><div class="card-title editable-text">Rendimiento Operacional</div><div class="card-desc editable-text">Eficiencia de rutas de recolección, tiempo de procesamiento, etc.</div></div></div>
          <div class="card reportes"><div class="card-icon"><i class="fa-solid fa-tree"></i></div><div class="card-content"><div class="card-title editable-text">Impacto Ambiental</div><div class="card-desc editable-text">Reducción de emisiones de CO2, ahorro de agua, etc.</div></div></div>
        </div>
      `,
      metas: `
        <div class="hero"><h1 class="editable-text">Gestión de Metas de Sostenibilidad</h1><p class="editable-text">Define, monitorea y ajusta tus metas ambientales. Un paso a la vez, hacia un futuro más sostenible.</p></div>
        <div class="cards">
          <div class="card metas"><div class="card-icon"><i class="fa-solid fa-minimize"></i></div><div class="card-content"><div class="card-title editable-text">Metas de Reducción</div><div class="card-desc editable-text">Objetivos para reducir el volumen de residuos generados.</div></div></div>
          <div class="card indicadores"><div class="card-icon"><i class="fa-solid fa-trash-arrow-up"></i></div><div class="card-content"><div class="card-title editable-text">Metas de Reciclaje</div><div class="card-desc editable-text">Aumentar la tasa de reciclaje en un porcentaje específico.</div></div></div>
          <div class="card avances"><div class="card-icon"><i class="fa-solid fa-chalkboard-user"></i></div><div class="card-content"><div class="card-title editable-text">Metas de Capacitación</div><div class="card-desc editable-text">Número de empleados o comunidades capacitadas en gestión de residuos.</div></div></div>
          <div class="card reportes"><div class="card-icon"><i class="fa-solid fa-award"></i></div><div class="card-content"><div class="card-title editable-text">Metas de Certificación</div><div class="card-desc editable-text">Lograr certificaciones de gestión ambiental.</div></div></div>
        </div>
      `,
      avances: `
        <div class="hero"><h1 class="editable-text">Progreso y Avances del Proyecto</h1><p class="editable-text">Visualiza el avance de tus iniciativas y proyectos. Celebra tus logros y ajusta lo que sea necesario para alcanzar el éxito.</p></div>
        <div class="cards">
          <div class="card metas"><div class="card-icon"><i class="fa-solid fa-tasks"></i></div><div class="card-content"><div class="card-title editable-text">Progreso en Proyectos</div><div class="card-desc editable-text">Seguimiento del estado de proyectos específicos.</div></div></div>
          <div class="card indicadores"><div class="card-icon"><i class="fa-solid fa-star"></i></div><div class="card-content"><div class="card-title editable-text">Hitos Alcanzados</div><div class="card-desc editable-text">Registro de logros importantes y acuerdos.</div></div></div>
          <div class="card avances"><div class="card-icon"><i class="fa-solid fa-arrow-trend-up"></i></div><div class="card-content"><div class="card-title editable-text">Análisis de Desempeño</div><div class="card-desc editable-text">Evaluación del rendimiento a lo largo del tiempo.</div></div></div>
          <div class="card reportes"><div class="card-icon"><i class="fa-solid fa-users"></i></div><div class="card-content"><div class="card-title editable-text">Información de Equipo</div><div class="card-desc editable-text">Colabora y coordina con tu equipo.</div></div></div>
        </div>
      `,
      reportes: `
        <div class="hero"><h1 class="editable-text">Generación y Descarga de Reportes</h1><p class="editable-text">Crea informes personalizados para tus stakeholders o para auditorías internas. Todos los datos, a tu alcance.</p></div>
        <div class="cards">
          <div class="card metas"><div class="card-icon"><i class="fa-solid fa-calendar-alt"></i></div><div class="card-content"><div class="card-title editable-text">Reportes Mensuales</div><div class="card-desc editable-text">Genera informes automáticos con datos del último mes.</div></div></div>
          <div class="card indicadores"><div class="card-icon"><i class="fa-solid fa-chart-pie"></i></div><div class="card-content"><div class="card-title editable-text">Reportes Financieros</div><div class="card-desc editable-text">Accede a reportes detallados sobre ingresos y gastos.</div></div></div>
          <div class="card avances"><div class="card-icon"><i class="fa-solid fa-balance-scale"></i></div><div class="card-content"><div class="card-title editable-text">Reportes de Cumplimiento</div><div class="card-desc editable-text">Prepara informes para cumplir con regulaciones y normativas.</div></div></div>
          <div class="card reportes"><div class="card-icon"><i class="fa-solid fa-cog"></i></div><div class="card-content"><div class="card-title editable-text">Reportes Personalizados</div><div class="card-desc editable-text">Crea tus propios informes desde cero con los datos que necesites.</div></div></div>
        </div>
      `,
      formularios: `
        <div class="hero"><h1 class="editable-text">Gestión y Creación de Formularios</h1><p class="editable-text">Diseña, despliega y administra formularios para la recolección de datos en campo. Agiliza la entrada de información.</p></div>
        <div class="cards">
          <div class="card formularios"><div class="card-icon"><i class="fa-solid fa-clipboard-check"></i></div><div class="card-content"><div class="card-title editable-text">Formularios de Inspección</div><div class="card-desc editable-text">Crea formularios para inspecciones de calidad o seguridad en las rutas.</div></div></div>
          <div class="card reportes"><div class="card-icon"><i class="fa-solid fa-exclamation-triangle"></i></div><div class="card-content"><div class="card-title editable-text">Reporte de Incidentes</div><div class="card-desc editable-text">Permite a los técnicos registrar incidentes o anomalías al instante.</div></div></div>
          <div class="card avances"><div class="card-icon"><i class="fa-solid fa-smile"></i></div><div class="card-content"><div class="card-title editable-text">Encuestas de Satisfacción</div><div class="card-desc editable-text">Recopila feedback de comunidades o clientes de forma sencilla.</div></div></div>
          <div class="card metas"><div class="card-icon"><i class="fa-solid fa-truck-loading"></i></div><div class="card-content"><div class="card-title editable-text">Registro de Recolección</div><div class="card-desc editable-text">Un formulario rápido para registrar el tipo y peso de los residuos recolectados.</div></div></div>
        </div>
      `
    };
    
    return pageData[page] || '<div class="hero"><h1>Página no encontrada</h1><p>La página solicitada no existe.</p></div>';
  }

  // Función para cargar el contenido de una página
  function loadPageContent(pageName) {
    if (currentPage === pageName) return;

    savePageContent();
    currentPage = pageName;
    
    let content = pageContent[pageName];
    if (!content) {
      content = getDefaultContent(pageName);
      pageContent[pageName] = content;
    }
    
    canvas.innerHTML = content;
    postLoad();
    adjustCanvasSize();
    updateCardAccessibility();
    
    // Actualizar navegación
    navLinks.forEach(l => l.classList.remove('active'));
    const newActiveLink = qs(`[data-page="${pageName}"]`);
    if (newActiveLink) {
      newActiveLink.classList.add('active');
    }
  }

  // Función para guardar el contenido de la página actual
  function savePageContent() {
    pageContent[currentPage] = canvas.innerHTML;
  }

  // Función para actualizar la accesibilidad de las tarjetas según el rol
  function updateCardAccessibility() {
    const cards = qsa('.cards .card');
    cards.forEach(card => {
      const isRestricted = card.dataset.page === 'metas' || card.dataset.page === 'avances' || card.dataset.page === 'reportes';
      if (isRestricted) {
        if (role === 'admin' || role === 'tecnico') {
          card.classList.remove('disabled');
          card.removeAttribute('data-disabled-message');
        } else {
          card.classList.add('disabled');
          card.dataset.disabledMessage = "Acceso denegado. Esta función no está disponible en este momento.";
        }
      }
    });
  }

  // Función para manejar inicio de sesión exitoso
  function handleLoginSuccess(username, userId) {
    // Determinar el rol basado en el nombre de usuario
    if (username.includes('admin')) {
      role = 'admin';
    } else if (username.includes('tecnico')) {
      role = 'tecnico';
    } else {
      role = 'viewer';
    }
    
    // Actualizar la UI según el rol
    updateUIForRole();
    
    // Mostrar información del usuario
    whoami.textContent = `Hola, ${username.split('@')[0]}`;
    whoami.style.display = 'inline';
    openAuth.style.display = 'none';
    logoutBtn.style.display = 'inline';
    
    // Ocultar modal de autenticación
    auth.style.display = 'none';
    
    // Guardar información de sesión
    localStorage.setItem('userRole', role);
    localStorage.setItem('username', username);
  }

  // Función para manejar cierre de sesión
  function handleLogout() {
    role = 'viewer';
    editMode = false;
    
    // Actualizar la UI
    updateUIForRole();
    
    // Ocultar elementos de usuario
    whoami.style.display = 'none';
    openAuth.style.display = 'inline';
    logoutBtn.style.display = 'none';
    
    // Limpiar almacenamiento local
    localStorage.removeItem('userRole');
    localStorage.removeItem('username');
  }

  // Función para actualizar la UI según el rol
  function updateUIForRole() {
    if (role === 'admin' || role === 'tecnico') {
      toggleEdit.style.display = 'inline';
      // Habilitar enlaces deshabilitados
      qsa('.nav-link.disabled').forEach(link => {
        link.classList.remove('disabled');
      });
    } else {
      toggleEdit.style.display = 'none';
      editMode = false;
      toggleEdit.classList.remove('active');
      mainWrap.classList.remove('edit-active');
      sidebar.classList.remove('active');
      canvas.classList.remove('editing');
      canvasToolbar.classList.remove('active');
      
      // Deshabilitar enlaces según el rol
      qsa('.nav-link:not([data-page="home"]):not([data-page="formularios"])').forEach(link => {
        link.classList.add('disabled');
      });
    }
    
    updateCardAccessibility();
  }

  // Función para guardar instantánea del historial
  const saveSnapshot = (delay=300) => {
    if(saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(()=>{
      pageContent[currentPage] = canvas.innerHTML;
      history.push(pageContent[currentPage]);
      if(history.length > 80) history.shift();
      redo.length = 0;
      saveTimeout = null;
    }, delay);
  };

  // Función para cargar después de cambios
  const postLoad = () => {
    qsa('.canvas-item').forEach(makeInteractive);
    updateEditModeStyles();
    selected = null;
    hideFloatbar();
    adjustCanvasSize();
  };

  // Función para actualizar estilos según el modo edición
  function updateEditModeStyles() {
    sidebar.classList.toggle('active', editMode);
    mainWrap.classList.toggle('edit-active', editMode);
    canvas.classList.toggle('editing', editMode);
    canvasToolbar.classList.toggle('active', editMode);
    
    // Hacer que todos los elementos existentes sean interactivos
    qsa('.editable-text, .hero, .card').forEach(el => {
        el.onmousedown = (e) => {
            if (editMode) {
                e.stopPropagation();
                selectItem(el);
            }
        };
        el.ondblclick = (e) => {
            if (editMode) {
                e.preventDefault();
                e.stopPropagation();
                const editableTarget = e.target.closest('.editable-text') || e.target;
                if (editableTarget) {
                    editableTarget.setAttribute('contenteditable', 'true');
                    editableTarget.focus();
                    currentEditable = editableTarget;
                    updatePropInputs(el);
                }
            }
        };
    });

    // Manejar nuevos elementos del canvas
    qsa('.canvas-item').forEach(item => {
      if (editMode) {
        makeInteractive(item);
      } else {
        item.classList.remove('selected');
        item.classList.remove('selectable');
        qsa('.handle', item).forEach(h => h.remove());
        item.onmousedown = null;
        item.ondblclick = null;
      }
    });

    // Manejar contenido editable para todos los elementos
    document.querySelectorAll('[contenteditable="true"]').forEach(el => {
      if (!editMode) {
          el.removeAttribute('contenteditable');
      }
    });

    if (!editMode) {
      selected = null;
      hideFloatbar();
    }
  }

  // Función para hacer elementos interactivos
  function makeInteractive(el){
    el.classList.add('selectable');
    
    qsa('.handle', el).forEach(h => h.remove());

    if(el.classList.contains('canvas-item')){
      ['nw','n','ne','e','se','s','sw','w','rotate'].forEach(pos=>{
        const h = document.createElement('div');
        h.className = 'handle '+pos;
        el.appendChild(h);
      });
    }

    el.onmousedown = e => {
      if(!editMode) return;
      const target = e.target;
      selectItem(el);
      
      document.querySelectorAll('[contenteditable="true"]').forEach(editable => {
        if (editable !== target) {
          editable.removeAttribute('contenteditable');
        }
      });

      if(el.classList.contains('canvas-item') && target.classList.contains('rotate')){
        e.preventDefault();
        const rect = el.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const startAngle = Math.atan2(e.clientY - cy, e.clientX - cx);
        const startRot = getRotation(el);

        const move = ev => {
          const a = Math.atan2(ev.clientY - cy, ev.clientX - cx);
          const deg = (a - startAngle) * 180/Math.PI + startRot;
          el.style.transform = `rotate(${deg}deg)`;
          updatePropInputs(el);
          showFloatbar(el);
        };
        const up = ()=>{ saveSnapshot(); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); };
        window.addEventListener('mousemove',move);
        window.addEventListener('mouseup',up);
        return;
      }

      if(el.classList.contains('canvas-item') && target.classList.contains('handle')){
        e.preventDefault();
        const pos = target.classList[1];
        const startX = e.clientX, startY = e.clientY;
        const start = getRect(el);
        const move = ev=>{
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          let {x,y,w,h} = {...start};

          if(pos.includes('e')) w = start.w + dx;
          if(pos.includes('s')) h = start.h + dy;
          if(pos.includes('w')) { w = start.w - dx; x = start.x + dx; }
          if(pos.includes('n')) { h = start.h - dy; y = start.y + dy; }

          w = Math.max(40,w); h = Math.max(40,h);
          if(snap){ x = Math.round(x/grid)*grid; y = Math.round(y/grid)*grid; w = Math.round(w/grid)*grid; h = Math.round(h/grid)*grid; }
          el.style.left = x+'px'; el.style.top = y+'px'; el.style.width = w+'px'; el.style.height = h+'px';
          updatePropInputs(el); showFloatbar(el);
          adjustCanvasSize();
        };
        const up=()=>{ saveSnapshot(); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); };
        window.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
        return;
      }

      if(el.classList.contains('canvas-item') && !target.closest('[contenteditable="true"]')){
        e.preventDefault();
        const startX = e.clientX, startY = e.clientY;
        const start = getRect(el);
        const move = ev=>{
          let x = start.x + (ev.clientX - startX);
          let y = start.y + (ev.clientY - startY);
          if(snap){ x = Math.round(x/grid)*grid; y = Math.round(y/grid)*grid; }
          el.style.left = x+'px'; el.style.top = y+'px';
          showFloatbar(el);
          updatePropInputs(el);
          adjustCanvasSize();
        };
        const up = ()=>{ saveSnapshot(); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up);};
        window.addEventListener('mousemove',move);
        window.addEventListener('mouseup',up);
      }
    };

    el.ondblclick = (e)=>{
      const target = e.target;
      if(target.tagName === 'A' || target.tagName === 'DIV' || target.tagName === 'P' || target.tagName === 'H1' || target.tagName === 'H2' || target.tagName === 'TD' || target.tagName === 'LI' || target.classList.contains('editable-text')){
          target.setAttribute('contenteditable','true');
          target.focus();
          currentEditable = target;
          updatePropInputs(selected);
          e.stopPropagation();
      }
    };

    el.addEventListener('focusout', (e)=>{
      const target = e.target;
      if(['H1','P','H2','TD','LI','A','DIV'].includes(target.tagName) || target.classList.contains('editable-text')){
        target.removeAttribute('contenteditable');
        currentEditable = null;
        saveSnapshot();
      }
    });
  }

  // Función para obtener la posición y dimensiones de un elemento
  function getRect(el){
    if (el.classList.contains('canvas-item')) {
      const style = window.getComputedStyle(el);
      const x = parseInt(style.left) || el.offsetLeft;
      const y = parseInt(style.top) || el.offsetTop;
      const w = parseInt(style.width) || el.offsetWidth;
      const h = parseInt(style.height) || el.offsetHeight;
      return { x, y, w, h };
    } else {
      const rect = el.getBoundingClientRect();
      const canvasRect = canvas.getBoundingClientRect();
      const x = rect.left - canvasRect.left;
      const y = rect.top - canvasRect.top;
      return { x, y, w: rect.width, h: rect.height };
    }
  }

  // Función para obtener la rotación de un elemento
  function getRotation(el){
    const m = (el.style.transform||'').match(/rotate\(([-\d.]+)deg\)/);
    return m ? parseFloat(m[1]) : 0;
  }

  // Función para seleccionar un elemento
  function selectItem(el){
    if(!editMode) return;
    qsa('.selected').forEach(s=>s.classList.remove('selected'));
    el.classList.add('selected'); selected = el;
    showFloatbar(el);
    updatePropInputs(el);
    highlightTabByType(el);
  }

  // Función para mostrar la barra flotante
  function showFloatbar(el){
    const r = el.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    const scrollX = canvas.scrollLeft;
    const scrollY = canvas.scrollTop;
    
    // Calcular posición relativa al canvas
    const newLeft = (r.left - canvasRect.left + scrollX) + (r.width / 2);
    const newTop = r.top - canvasRect.top + scrollY - floatbar.offsetHeight - 8;
    
    floatbar.style.left = newLeft + 'px';
    floatbar.style.top = newTop + 'px';
    floatbar.style.display = 'flex';

    const isCanvasItem = el.classList.contains('canvas-item');
    const isHero = el.classList.contains('hero');

    qs('#fb-front').style.display = isCanvasItem ? 'flex' : 'none';
    qs('#fb-back').style.display = isCanvasItem ? 'flex' : 'none';
    qs('#fb-del').style.display = isHero ? 'none' : 'flex';
  }

  // Función para ocultar la barra flotante
  function hideFloatbar(){ floatbar.style.display='none'; }

  // Función para restablecer la selección del canvas
  function resetCanvasSelection(){
    qsa('.selected').forEach(s=>s.classList.remove('selected'));
    selected = null;
    hideFloatbar();
    qs('#sec-general').classList.add('active');
    qsa('#prop-tabs button').forEach(b => b.classList.remove('active'));
    qs('[data-tab="general"]').classList.add('active');
  }

  // Función para ajustar el tamaño del canvas
  function adjustCanvasSize() {
    let maxBottom = 0;
    const allElements = qsa('.selectable, .editable-text, .canvas-item, .hero, .card, .cards');
    allElements.forEach(item => {
        const rect = item.getBoundingClientRect();
        const bottom = rect.top + rect.height;
        if (bottom > maxBottom) {
            maxBottom = bottom;
        }
    });
    
    // Convertir maxBottom a un valor relativo a la parte superior del canvas
    const canvasTop = canvas.getBoundingClientRect().top;
    const canvasMinHeight = maxBottom - canvasTop + 40; // Agregar algo de relleno en la parte inferior
    
    // Asegurar que el canvas tenga al menos la altura del viewport
    const viewportHeight = window.innerHeight - qs('.topbar').offsetHeight - 36;
    canvas.style.minHeight = Math.max(viewportHeight, canvasMinHeight) + 'px';
  }

  // Event Listeners
  openAuth.addEventListener('click', () => auth.style.display = 'flex');
  closeAuthBtn.addEventListener('click', () => auth.style.display = 'none');
  qs('#auth-close').addEventListener('click', () => auth.style.display = 'none');
  
  // Botón de login
  qs('#btn-login').addEventListener('click', async () => {
    const user = qs('#login-user').value;
    const pass = qs('#login-pass').value;
    
    // Autenticar con Supabase
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email: `${user}@example.com`, // Usar un dominio ficticio
      password: pass
    });
    
    if (error) {
      alert('Error de autenticación: ' + error.message);
    }
    // El resto del manejo se hace en onAuthStateChange
  });
  
  // Botón de logout
  logoutBtn.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
  });
  
  // Toggle de modo edición
  toggleEdit.addEventListener('click', async () => {
    if (role !== 'admin' && role !== 'tecnico') return;
    
    editMode = !editMode;
    toggleEdit.classList.toggle('active', editMode);
    
    if (!editMode) {
      // Al desactivar el modo edición, guardar los cambios en Supabase
      await saveContentToSupabase();
    }
    
    updateEditModeStyles();
  });
  
  // Navegación entre páginas
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      if (link.classList.contains('disabled')) return;
      
      const page = link.dataset.page;
      loadPageContent(page);
    });
  });

  // Botones de la barra flotante
  qs('#fb-dup').onclick = ()=>{ 
    if(!selected) return; 
    saveSnapshot(); 
    const clone = selected.cloneNode(true);
    
    // Eliminar clase selected del elemento clonado
    clone.classList.remove('selected');
    
    if (selected.classList.contains('canvas-item')) {
      const rect = getRect(selected);
      clone.style.left = (rect.x + 20) + 'px';
      clone.style.top = (rect.y + 20) + 'px';
      canvas.appendChild(clone); 
      makeInteractive(clone);
    } else {
        const parent = selected.parentElement;
        parent.appendChild(clone);
    }
    
    selectItem(clone); 
    adjustCanvasSize(); 
  };

  qs('#fb-front').onclick = ()=>{ 
    if(!selected) return; 
    saveSnapshot(); 
    let currentZ = parseInt(window.getComputedStyle(selected).zIndex) || 1;
    selected.style.zIndex = Math.max(currentZ, 2) + 1;
  };

  qs('#fb-back').onclick = ()=>{ 
    if(!selected) return; 
    saveSnapshot(); 
    let currentZ = parseInt(window.getComputedStyle(selected).zIndex) || 1;
    selected.style.zIndex = Math.max(1, currentZ - 1);
  };

  qs('#fb-del').onclick = ()=>{ 
    if(!selected) return; 
    saveSnapshot(); 
    selected.remove();
    selected=null; 
    hideFloatbar(); 
    adjustCanvasSize(); 
  };

  // Botones de la barra de herramientas del canvas
  qs('#duplicate').onclick = ()=> qs('#fb-dup').click();
  qs('#bring-front').onclick = ()=> qs('#fb-front').click();
  qs('#send-back').onclick = ()=> qs('#fb-back').click();
  qs('#remove').onclick = ()=> qs('#fb-del').click();

  // Eventos del canvas
  canvas.addEventListener('mousedown', (e)=>{ if(!editMode) return; if(e.target===canvas){ resetCanvasSelection(); }});
  
  document.addEventListener('mousedown', (e) => {
    if (editMode) {
      const target = e.target;
      const isClickInsideCanvas = canvas.contains(target);
      const isClickInsideSidebar = sidebar.contains(target);
      const isClickInsideFloatbar = floatbar.contains(target);
      const isSelectableTarget = target.closest('.selectable, .editable-text, .hero, .card');

      if (!isSelectableTarget && !isClickInsideSidebar && !isClickInsideFloatbar) {
        resetCanvasSelection();
      }
    }
  });
  
  // Evento para elementos de la página de inicio
  canvas.addEventListener('click', (e) => {
    if (!editMode) {
      const card = e.target.closest('.card');
      if (card) {
          if (card.classList.contains('disabled')) {
              e.preventDefault();
              const message = card.dataset.disabledMessage || "Acceso denegado.";
              alert(message);
              return;
          }
          if (card.dataset.page) {
              e.preventDefault();
              loadPageContent(card.dataset.page);
              return;
          }
      }
    }

    let target = e.target;
    let selectableElement = target.closest('.selectable, .editable-text, .hero, .card');

    if (selectableElement) {
        selectItem(selectableElement);
    } else {
        resetCanvasSelection();
    }
  });

  // Botones de inserción
  qsa('[data-insert]').forEach(btn=>{
    btn.onclick=()=>{
      if(!editMode) return;
      const type = btn.dataset.insert;
      const item = document.createElement('div');
      item.className = 'canvas-item selectable';
      item.style.left = '40px'; item.style.top = '40px';
      item.style.width = '240px'; item.style.height = '60px';
      item.dataset.type = type;

      if(type==='h2'){ item.innerHTML = '<h2 class="canvas-h2 editable-text">Nuevo título</h2>'; }
      if(type==='p'){ item.innerHTML = '<p class="canvas-p editable-text">Nuevo texto</p>'; item.style.height='80px'; }
      if(type==='img'){ item.innerHTML = `<img src="https://i.imgur.com/kS9QJkP.png" alt="Imagen" class="canvas-img" draggable="false">`; item.style.height='160px'; }
      if(type==='button'){ item.innerHTML = '<a href="#" class="canvas-button editable-text" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center">Botón</a>'; item.style.height='48px'; }
      if(type==='iframe'){ item.innerHTML = `<div class="video-wrapper" style="width:100%;height:100%;position:relative;">
        <iframe src="" width="100%" height="100%" style="border:0;border-radius:10px;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>`; item.style.width='360px'; item.style.height='200px'; }
      if(type==='table'){ item.style.width='360px'; item.style.height='180px';
        item.innerHTML = `<table class="canvas-table">
          <tbody>
            <tr><td contenteditable="true">A1</td><td contenteditable="true">B1</td></tr>
            <tr><td contenteditable="true">A2</td><td contenteditable="true">B2</td></tr>
          </tbody></table>`;
      }

      saveSnapshot();
      canvas.appendChild(item);
      makeInteractive(item);
      selectItem(item);
      adjustCanvasSize();
    }
  });

  // Pestañas de propiedades
  const tabBtns = qsa('#prop-tabs .tab');
  const sections = {
    general: qs('#sec-general'), texto: qs('#sec-texto'), imagen: qs('#sec-imagen'),
    video: qs('#sec-video'), boton: qs('#sec-boton'), tabla: qs('#sec-tabla'), lienzo: qs('#sec-lienzo')
  };
  tabBtns.forEach(b=>{ b.onclick=()=>{ tabBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); Object.values(sections).forEach(s=>s.classList.remove('active')); sections[b.dataset.tab].classList.add('active'); }});

  // Inicializar la aplicación
  initApp();
})();
</script>
</body>
</html>
